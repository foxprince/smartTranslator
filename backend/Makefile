# ç¿»è¯‘ç³»ç»Ÿ Makefile
# æä¾›å¸¸ç”¨çš„å¼€å‘å’Œæµ‹è¯•å‘½ä»¤

.PHONY: help install test test-unit test-integration test-api test-coverage test-fast clean lint format check-deps run dev

# é»˜è®¤ç›®æ ‡
help:
	@echo "ç¿»è¯‘ç³»ç»Ÿå¼€å‘å·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install        - å®‰è£…ä¾èµ–"
	@echo "  test           - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-unit      - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-integration - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  test-api       - è¿è¡ŒAPIæµ‹è¯•"
	@echo "  test-coverage  - è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  test-fast      - å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰"
	@echo "  lint           - ä»£ç é£æ ¼æ£€æŸ¥"
	@echo "  format         - ä»£ç æ ¼å¼åŒ–"
	@echo "  check-deps     - æ£€æŸ¥ä¾èµ–"
	@echo "  clean          - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  run            - è¿è¡Œå¼€å‘æœåŠ¡å™¨"
	@echo "  dev            - å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰"

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
	pip install -r requirements.txt
	pip install -r requirements-dev.txt

# æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
	pip check
	@echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	python run_tests.py --type all

# è¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	python run_tests.py --type unit

# è¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	python run_tests.py --type integration

# è¿è¡ŒAPIæµ‹è¯•
test-api:
	@echo "ğŸ§ª è¿è¡ŒAPIæµ‹è¯•..."
	python run_tests.py --type api

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-coverage:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	python run_tests.py --coverage --report

# å¿«é€Ÿæµ‹è¯•
test-fast:
	@echo "ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•..."
	python run_tests.py --fast

# å¹¶è¡Œæµ‹è¯•
test-parallel:
	@echo "ğŸ§ª è¿è¡Œå¹¶è¡Œæµ‹è¯•..."
	python run_tests.py --parallel 4

# ä»£ç é£æ ¼æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç é£æ ¼æ£€æŸ¥..."
	flake8 app/ --max-line-length=100 --ignore=E203,W503
	@echo "ğŸ” ç±»å‹æ£€æŸ¥..."
	mypy app/ --ignore-missing-imports
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ ä»£ç æ ¼å¼åŒ–..."
	black app/ tests/ --line-length=100
	isort app/ tests/ --profile black
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# å®‰å…¨æ£€æŸ¥
security:
	@echo "ğŸ”’ å®‰å…¨æ£€æŸ¥..."
	bandit -r app/ -f json -o reports/security_report.json || true
	safety check --json --output reports/safety_report.json || true
	@echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf reports/
	rm -rf .coverage
	@echo "âœ… æ¸…ç†å®Œæˆ"

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
run:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	uvicorn app.main:app --host 0.0.0.0 --port 8000

# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰..."
	uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# ç”Ÿäº§æ¨¡å¼
prod:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨..."
	gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "ğŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
	alembic upgrade head

# åˆ›å»ºæ–°è¿ç§»
migration:
	@echo "ğŸ—„ï¸ åˆ›å»ºæ–°è¿ç§»..."
	@read -p "è¿ç§»æè¿°: " desc; \
	alembic revision --autogenerate -m "$$desc"

# é‡ç½®æ•°æ®åº“
reset-db:
	@echo "ğŸ—„ï¸ é‡ç½®æ•°æ®åº“..."
	alembic downgrade base
	alembic upgrade head

# ç”ŸæˆAPIæ–‡æ¡£
docs:
	@echo "ğŸ“š ç”ŸæˆAPIæ–‡æ¡£..."
	python -c "import app.main; print('APIæ–‡æ¡£: http://localhost:8000/docs')"

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker build -t translation-backend .

# è¿è¡ŒDockerå®¹å™¨
docker-run:
	@echo "ğŸ³ è¿è¡ŒDockerå®¹å™¨..."
	docker run -p 8000:8000 translation-backend

# å®Œæ•´çš„CIæ£€æŸ¥
ci: clean install lint test-coverage security
	@echo "âœ… CIæ£€æŸ¥å®Œæˆ"

# å‘å¸ƒå‰æ£€æŸ¥
pre-release: clean install lint test-coverage security docs
	@echo "ğŸš€ å‘å¸ƒå‰æ£€æŸ¥å®Œæˆ"

# æ€§èƒ½æµ‹è¯•
perf:
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	locust -f tests/performance/locustfile.py --host=http://localhost:8000

# ç›‘æ§æœåŠ¡çŠ¶æ€
health:
	@echo "ğŸ’“ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	curl -f http://localhost:8000/health || echo "æœåŠ¡æœªè¿è¡Œ"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—..."
	tail -f logs/app.log

# å¤‡ä»½æ•°æ®åº“
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	pg_dump translation_db > backups/db_backup_$(shell date +%Y%m%d_%H%M%S).sql

# æ¢å¤æ•°æ®åº“
restore:
	@echo "ğŸ”„ æ¢å¤æ•°æ®åº“..."
	@read -p "å¤‡ä»½æ–‡ä»¶è·¯å¾„: " file; \
	psql translation_db < "$$file"

# ç¯å¢ƒä¿¡æ¯
env-info:
	@echo "ğŸ”§ ç¯å¢ƒä¿¡æ¯:"
	@echo "Pythonç‰ˆæœ¬: $(shell python --version)"
	@echo "Pipç‰ˆæœ¬: $(shell pip --version)"
	@echo "å½“å‰ç›®å½•: $(shell pwd)"
	@echo "Gitåˆ†æ”¯: $(shell git branch --show-current 2>/dev/null || echo 'N/A')"
	@echo "Gitæäº¤: $(shell git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
